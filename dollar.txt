#include "../../includes/minishell.h"

void	dollar4(t_dollar *d)
{
	if (d->del_dollar_flag == 1)
	{
		d->i = d->i - 2;
		if (d->i < 0)
			d->i = 0;
	}
	else if (d->del_dollar_flag == 2)
		d->i--;
	d->i++;
}

void	dollar3(char *str, t_dollar *d, t_dict *dictionary)
{
	if (d->j == 0)
	{
		d->is_value = 0;
		d->i--;
		str = ft_replace(str, d, dictionary, 0);
		d->del_dollar_flag = 1;
	}
	else if (str[d->i] >= '0' && str[d->i] <= '9')
	{
		d->is_value = 0;
		d->i--;
		d->j = 1;
		str = ft_replace(str, d, dictionary, 0);
		d->del_dollar_flag = 1;
	}
	else
	{
		d->del_dollar_flag = 1;
		d->dollar_word = ft_substr(str, d->i, d->j);
		d->is_value = 1;
		d->i--;
		str = ft_replace(str, d, dictionary, 
				in_single_or_double_qut(str, d->i, d->qut_num, 2));
	}
	d->i++;
}

int	dollar2(char *str, t_dollar *d, t_execution *exec)
{
	d->del_dollar_flag = 2;
	d->i++;
	if (str[d->i] == '?')
	{
		str = subsitute_exit_code(str, d->i, exec);
		return (1);
	}
	d->j = 0;
	while ((str[d->j + d->i] == '_' || ft_isalnum(str[d->j + d->i]) == 1))
		d->j++;
	if (str[d->i] == '#')
		str[d->i] = '0';
	return (0);
}

int	dollar_inside_if(char *str, t_dollar *d, 
	t_execution *exec, t_dict *dictionary)
{
	if (dollar2(str, d, exec) == 1)
		return (1);
	if ((str[d->i] == '\'' || str[d->i] == '"') 
		&& in_single_or_double_qut(str, d->i, d->qut_num, 2) == 0)
	{
		str[d->i - 1] = ' ';
		d->del_dollar_flag = 1;
	}
	else if (str[d->i] == ' ' || str[d->i] == '\'' 
		|| str[d->i] == '"' || str[d->i] == '\0')
		return (1);
	else
		dollar3(str, d, dictionary);
	return (0);
}

char	*dollar(char *str, t_dict *dictionary, t_execution *exec)
{
	t_dollar	d;

	d.i = 0;
	d.qut_num[0] = 0;
	d.qut_num[1] = 0;
	while (str[d.i] != '\0')
	{
		d.del_dollar_flag = 0;
		if ((in_single_or_double_qut(str, d.i, d.qut_num, 1) == 2 
				&& str[d.i] == '$') || (in_single_or_double_qut(str, d.i, 
					d.qut_num, 2) == 0 && str[d.i] == '$'))
		{
			if (dollar_inside_if(str, &d, exec, dictionary) == 1)
				continue ;
		}
		dollar4(&d);
	}
	return (str);
}